<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Samba over Tailscale/Wireguard - (no title)</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Samba over Tailscale/Wireguard"><meta itemprop=description content="I recently found out about Tailscale, a control plane for WireGuard. I decided to revisit an old project of mine and use it to set up a Samba server on an long ignored dedicated server so that I could access my videos remotely. However, the process proved to be more challenging than I had anticipated.
Goal The goal was to access my videos from the server via my Windows PC and Android phone, while also ensuring that the data was secure in transit, and not accessed by others."><meta itemprop=datePublished content="2023-01-04T18:14:39+00:00"><meta itemprop=dateModified content="2023-01-04T18:14:39+00:00"><meta itemprop=wordCount content="784"><meta itemprop=keywords content="server,samba,tailscale,wireguard,"><meta property="og:title" content="Samba over Tailscale/Wireguard"><meta property="og:description" content="I recently found out about Tailscale, a control plane for WireGuard. I decided to revisit an old project of mine and use it to set up a Samba server on an long ignored dedicated server so that I could access my videos remotely. However, the process proved to be more challenging than I had anticipated.
Goal The goal was to access my videos from the server via my Windows PC and Android phone, while also ensuring that the data was secure in transit, and not accessed by others."><meta property="og:type" content="article"><meta property="og:url" content="https://hartmantam.xyz/posts/samba-over-tailscale-wireguard/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-04T18:14:39+00:00"><meta property="article:modified_time" content="2023-01-04T18:14:39+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Samba over Tailscale/Wireguard"><meta name=twitter:description content="I recently found out about Tailscale, a control plane for WireGuard. I decided to revisit an old project of mine and use it to set up a Samba server on an long ignored dedicated server so that I could access my videos remotely. However, the process proved to be more challenging than I had anticipated.
Goal The goal was to access my videos from the server via my Windows PC and Android phone, while also ensuring that the data was secure in transit, and not accessed by others."><link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://hartmantam.xyz/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://hartmantam.xyz/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://hartmantam.xyz/css/dark.css><script src=https://hartmantam.xyz/js/main.js></script></head><body><div class="container wrapper"><div class=header><h1 class=site-title><a href=https://hartmantam.xyz/>(no title)</a></h1><div class=site-description><p>Anything can show up here</p><nav class="nav social"><ul class=flat></ul></nav></div><nav class=nav><ul class=flat><li><a href=/posts>Posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>04</span>
<span class=rest>Jan 2023</span></div></div><div class=matter><h1 class=title>Samba over Tailscale/Wireguard</h1></div></div><div class=markdown><p>I recently found out about Tailscale, a control plane for WireGuard. I decided to revisit an old project of mine and use it to set up a Samba server on an long ignored dedicated server so that I could access my videos remotely. However, the process proved to be more challenging than I had anticipated.</p><h2 id=goal>Goal</h2><p>The goal was to access my videos from the server via my Windows PC and Android phone, while also ensuring that the data was secure in transit, and not accessed by others. On my PC, I planned to use Windows&rsquo; native SMB support. On my Android phone, I intended to use the MX Player app to access the videos.</p><h2 id=problem>Problem</h2><p>One of the main reasons I initially chose not to serve SMB over the internet was due to security concerns. While SMB is commonly used in LAN, it is not designed for use over the internet and may not provide adequate security when used in this manner. Additionally, the Android app I&rsquo;m using only supports SMB, so I had no other choice but to use it.</p><h2 id=solution>Solution</h2><p>The solution I came up with was to tunnel all Samba traffic through Tailnet, the WireGuard network managed by Tailscale. This way, I could benefit from the security provided by WireGuard and the authentication provided by Tailscale. Completing the goal of secure data in transit and authenticated access.</p><h3 id=alternate-solution>Alternate Solution</h3><p>Another solution would have been to use a traditional VPN like OpenVPN, but this introduces a major drawback: all of my traffic would have to go through the VPN. While it is possible to use advanced configurations to avoid this issue, I did not have sufficient knowledge of networking to do so. When WireGuard first came out, I considered using it, but ultimately decided not to because I was unfamiliar with overlay networks and the work required to manage such a network.</p><h2 id=implementation>Implementation</h2><p>I won&rsquo;t go into detail on the process of setting up Samba or Tailscale, as I am not an expert in Samba configuration and Tailscale have a easy to follow quick start.</p><h3 id=initial-configuration>Initial Configuration</h3><p>After consulting the documentation, I believed the following configuration would be sufficient:</p><pre tabindex=0><code>[global]
    
    interfaces = lo tailnet0        # Listens on Tailscale and loopback interface
    bind interfaces only = yes      # Only listen

[share]
    path = /home/user/share
    read only = no
    valid user = user               # Defense in depth, more layer protection is always better
</code></pre><h3 id=debugging-the-issue>Debugging the Issue</h3><p>Unfortunately, this configuration did not work as expected. The Samba server did not bind to the Tailscale interface. Upon further investigation, I read a
<a href=https://unix.stackexchange.com/a/613409 target=_blank>post on Unix StackExchange</a> that Samba will not listen Wireguard interface unless IP and netmask are given. As a result, I modified the configuration as follows:</p><pre tabindex=0><code>[global]
    interfaces = lo 100.64.0.0/10   # 100.64.0.0/10 is the IP range that Tailscale assigns
    bind interfaces only = yes

[share]
    path = /home/user/share
    read only = no
    valid user = user
</code></pre><p>Sadly, this modification did not resolve the issue and the Samba server still did not listen. Despite spending two days trying to resolve the problem, I reread the documentation and discovered the following information regarding the <code>bind interface only</code> parameter:</p><blockquote><p>&mldr; Note that you should not use this parameter for machines that are serving PPP or other intermittent or non-broadcast network interfaces as it will not cope with non-permanent interfaces. &mldr;</p></blockquote><h2 id=final-configuration>Final Configuration</h2><p>This led me to realize that the <code>bind interfaces only</code> parameter was causing the issue. However, simply disabling it would cause the server to listen on every broadcast-capable interface in addition to the Tailscale interface.</p><p>To minimize the effect, I decided to use the <code>hosts allow</code> parameter to restrict access to only clients on the same Tailscale network and enable hidden share. However, this is not a perfect solution. Upon port scan, one can still see the server have Samba installed. People can still visit the root directory, although they can&rsquo;t see any share. Still, I deemed it should be sufficient for meeting my goal.</p><p>The final configuration I used is shown below:</p><pre tabindex=0><code>[global]
    interfaces = lo 100.64.0.0/10

[share$]                            # The trailing dollar sign makes it hidden
    path = /home/user/share
    read only = no
    valid user = user
    hosts allow = 100.64.0.0/10     # Clients on the same Tailnet will have the same IP range
</code></pre><h2 id=conclusion>Conclusion</h2><p>In conclusion, it is not advisable to serve SMB over the internet due to security concerns. However, by using Tailscale, the hosts allow parameter, and hidden share, it is possible to securely serve SMB to clients within a specific network. While Tailscale&rsquo;s access control can be used to implement more stringent access control lists (ACLs), it was not necessary in my case as I was the only user.</p></div><div class=tags><ul class=flat><li><a href=/tags/server>server</a></li><li><a href=/tags/samba>samba</a></li><li><a href=/tags/tailscale>tailscale</a></li><li><a href=/tags/wireguard>wireguard</a></li></ul></div></div></div><div class="footer wrapper"><nav class=nav><div>2023 CC BY 4.0 | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div></body></html>